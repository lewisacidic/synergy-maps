"use strict";function rgb2string(a){return"rgb("+a.r+", "+a.g+", "+a.b+")"}function string2rgb(a){var b=a.split("(")[1].split(")")[0].split(",");return{r:parseInt(b[0]),g:parseInt(b[1]),b:parseInt(b[2])}}function rgb2string(a){return"rgb("+a.r+", "+a.g+", "+a.b+")"}function extendSlider(){$.extend($.ui.slider.prototype.options,{minRangeSize:0,maxRangeSize:100,autoShift:!1,lowMax:100,topMin:0}),$.extend($.ui.slider.prototype,{_slide:function(a,b,c){var d,e,f,g;this.options.values&&this.options.values.length?(d=this.values(b?0:1),g=0===b?1:-1,2===this.options.values.length&&this.options.range===!0&&(0===b&&c>this.options.lowMax&&(c=this.options.lowMax),1===b&&c<this.options.topMin&&(c=this.options.topMin),(d-c)*g<this.options.minRangeSize&&(this.options.autoShift===!0?d=c+this.options.minRangeSize*g:c=d-this.options.minRangeSize*g),(d-c)*g>this.options.maxRangeSize&&(this.options.autoShift===!0?d=c+this.options.maxRangeSize*g:c=d-this.options.maxRangeSize*g)),c!==this.values(b)&&(e=this.values(),e[b]=c,e[b?0:1]=d,f=this._trigger("slide",a,{handle:this.handles[b],value:c,values:e}),f!==!1&&(this.values(b,c,!0),this.values(b?0:1,d,!0)))):c!==this.value()&&(f=this._trigger("slide",a,{handle:this.handles[b],value:c}),f!==!1&&this.value(c))}})}angular.module("frontendApp",["oitozero.ngSweetAlert","angular.filter","colorpicker.module","picardy.fontawesome","mm.foundation","angulartics","angulartics.google.analytics","ngAnimate","ngCookies","ngResource","ngRoute","ngSanitize","ngTouch"]).config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/examples/:dataset",{templateUrl:"views/map.html",controller:"MapCtrl"}).otherwise({redirectTo:"/"})}]),angular.module("frontendApp").controller("MainCtrl",["$scope","dataService",function(a,b){b.getExampleList().then(function(){b.empty(),a.datasets=b.exampleList})}]),angular.module("frontendApp").controller("NavCtrl",["$scope","$modal","dataService","SweetAlert",function(a,b,c,d){a.dataService=c,a.currentSearch="",a.getInfo=function(a,b){a.stopPropagation(),console.log(c.metadata),d.swal({title:b,html:c.metadata[b],allowOutsideClick:!0})},a.select=function(a){c.model.selected=a,console.log(c.model.selected)},a.openSettings=function(){console.log(c),b.open({templateUrl:"views/settings.html",controller:"SettingsCtrl"})}}]),angular.module("frontendApp").controller("SettingsCtrl",["$scope","$modalInstance","settings",function(a,b,c){a.colors={antagonismColor:rgb2string(c.colors.antagonismColor),synergyColor:rgb2string(c.colors.synergyColor)},a.$watch("colors",function(a){c.colors.antagonismColor=string2rgb(a.antagonismColor),c.colors.synergyColor=string2rgb(a.synergyColor),console.log(c.colors)},!0),a.colorBlindMode=function(){c.colors.antagonismColor="rgb(255,255,255)",c.colors.synergyColor="rgb(100,100,100)"},a.reset=function(){c.colors=c.defaultColors},a.dismiss=function(){b.dismiss("cancel")}}]),angular.module("frontendApp").service("settings",function(){this.defaultColors={synergyColor:{r:0,g:0,b:255},antagonismColor:{r:255,g:0,b:0}},this.colors=$.extend(!0,{},this.defaultColors),this.combinationThickness=20,this.activityThickness=20}),angular.module("frontendApp").directive("synergyMap",function(){function a(a,b){var c,d,e,f,g=d3.tip().attr("class","d3-tip").html(function(a){return a.name}),h=b[0],i=d3.select(h).append("svg").attr({"class":"viz"}).style(a.svgStyle);i.on("click",function(){d3.event.defaultPrevented||(a.selected=null,a.$apply())}),i.call(g);var j=i.append("g"),k=1,l=d3.behavior.zoom().scaleExtent([.1,10]).on("zoom",function(){g.hide(),k=d3.event.scale,j.attr("transform","translate("+d3.event.translate+")scale("+d3.event.scale+")"),i.selectAll("circle").attr("r",function(a){return e(a.value)/d3.event.scale}).attr("stroke-width",function(){return 1/d3.event.scale}),i.selectAll("line").attr("stroke-width",function(a){return f(Math.abs(a.value))/d3.event.scale})});l(i),a.$watch("svgStyle",function(a){i.style(a)},!0),a.$watch("[data, synergyColor, antagonismColor]",function(b){var h=b[0],i=rgb2string(b[1]),l=rgb2string(b[2]);if("undefined"!=typeof h){c=d3.scale.linear().domain(d3.extent(h.compounds,function(a){return a.x})).range([10,90]),d=d3.scale.linear().domain(d3.extent(h.compounds,function(a){return a.y})).range([10,90]),e=d3.scale.linear().domain(d3.extent(h.compounds,function(a){return a.value})).range([.1*a.activityThickness,a.activityThickness]),f=d3.scale.linear().domain(d3.extent(h.combinations,function(a){return Math.abs(a.value)})).range([0,a.combinationThickness]);var m=j.selectAll("line").data(h.combinations),n=j.selectAll("circle").data(h.compounds);m.enter().append("line").attr({x1:function(a){return c(a.source.x)+"%"},y1:function(a){return d(a.source.y)+"%"},x2:function(a){return c(a.target.x)+"%"},y2:function(a){return d(a.target.y)+"%"},"stroke-width":function(a){return f(Math.abs(a.value))},stroke:function(a){return a.synergistic===!0?i:l},"class":"combination"}),m.transition().duration(750).attr("x1",function(a){return c(a.source.x)+"%"}).attr("y1",function(a){return d(a.source.y)+"%"}).attr("x2",function(a){return c(a.target.x)+"%"}).attr("y2",function(a){return d(a.target.y)+"%"}).attr("stroke-width",function(a){return f(Math.abs(a.value))/k}).attr("stroke",function(a){return a.synergistic===!0?i:l}),m.exit().remove(),m.on("mouseover",function(a){d3.select(this).classed("highlighted",!0),n.classed("highlighted",function(b){return b===a.source||b===a.target})}),m.on("mouseout",function(){d3.select(this).classed("highlighted",!1),n.classed("highlighted",!1)}),m.on("click",function(b){d3.event.defaultPrevented||(d3.event.preventDefault(),a.selected=b===a.selected?null:b,a.$apply())}),n.enter().append("circle").attr({cx:function(a){return c(a.x)+"%"},cy:function(a){return d(a.y)+"%"},r:function(a){return e(a.value)/k},"class":"compound"}).classed("selected",function(b){return b===a.selected}),n.transition().duration(750).attr("cx",function(a){return c(a.x)+"%"}).attr("cy",function(a){return d(a.y)+"%"}).attr("r",function(a){return e(a.value)/k}),n.exit().remove(),n.on("mouseover",function(a){g.show(a),d3.select(this).classed("highlighted",!0),m.classed("highlighted",function(b){return b.source===a||b.target===a})}),n.on("mouseout",function(){g.hide(),d3.select(this).classed("highlighted",!1),m.classed("highlighted",!1)}),n.on("click",function(b){d3.event.defaultPrevented||(d3.event.preventDefault(),g.show(b),a.selected=b===a.selected?null:b,a.$apply())}),a.$watch("[lowCutOff, highCutOff]",function(a){var b=a[0],c=a[1];console.log(b,c),m.classed("hidden",function(a){return!(a.value>c||a.value<b)})}),a.$watch("selected",function(b){void 0!==b&&(null===b?(n.classed("selected",!1),m.classed("selected",!1)):(n.classed("selected",function(c){return a.data.compounds.indexOf(b)>-1?c===b:b.source===c||b.target===c}),m.classed("selected",function(a){return a===b||a.source===b||a.target===b})))})}},!0)}return{restrict:"E",link:a,scope:{data:"=",synergyColor:"=",antagonismColor:"=",svgStyle:"=",selected:"=",highlighted:"=",activityThickness:"=",combinationThickness:"=",lowCutOff:"=",highCutOff:"="}}}),angular.module("frontendApp").factory("dataService",["$http","$q",function(a,b){var c={};return c.exampleList=[],c.model={selected:null,highlighted:[]},c.getExampleList=function(d){var e=b.defer();return a.get("data/metadata.json").then(function(a){c.exampleList.length=0,a.data.datasets.forEach(function(a){c.exampleList.push(a)}),e.resolve(a)}).then(d),e.promise},c.data=null,c.available={representationTypes:[],dimensionalityReductionTypes:[],synergyTypes:[],activityTypes:[]},c.current={representationType:null,dimensionalityReductionType:null,synergyType:null,activityType:null},c.setRepresentationType=function(a){console.log("Set representation to "+a),c.current.representationType=a,c.available.dimensionalityReductionTypes.length=0,Object.keys(c.data.coordinates[this.current.representationType]).forEach(function(a){c.available.dimensionalityReductionTypes.push(a)}),c.setDimensionalityReductionType(c.available.dimensionalityReductionTypes.indexOf(c.current.dimensionalityReductionType)>-1?c.current.dimensionalityReductionType:c.available.dimensionalityReductionTypes[0])},c.setDimensionalityReductionType=function(a){console.log("Set dim red type:"+a),this.current.dimensionalityReductionType=a;var b=this.data.coordinates[this.current.representationType][this.current.dimensionalityReductionType];this.data.compounds.forEach(function(a){a.x=b[a.id].x,a.y=b[a.id].y})},c.setSynergyType=function(a){console.log("Set synergy type:",a),c.current.synergyType=a,c.data.combinations.forEach(function(b){b.value=b.synergies[a],b.synergistic=b.value>0})},c.setActivityType=function(a){console.log("Set activityType:",a),c.current.activityType=a,c.data.compounds.forEach(function(b){b.value=b.activities[a]})},c.linkUp=function(){var a={};return this.data.compounds.forEach(function(b){b.combinations=[],a[b.id]=b}),this.data.combinations.forEach(function(b){b.source=a[b.ColId],b.target=a[b.RowId]}),this},c.empty=function(){return this.available.representationTypes.length=0,this.available.dimensionalityReductionTypes.length=0,this.available.synergyTypes.length=0,this.available.activityTypes.length=0,this.current.representationType=null,this.current.dimensionalityReductionType=null,this.current.synergyType=null,this.current.activityType=null,this},c.initializeData=function(){return this.empty(),this.metadata={},this.data.metadata.representationTypes.forEach(function(a){c.metadata[a.name]=a.metadata,c.available.representationTypes.push(a.name)}),this.data.metadata.dimensionalityReductionTypes.forEach(function(a){c.metadata[a.name]=a.metadata}),this.setRepresentationType(this.available.representationTypes[0]),this.data.metadata.activityTypes.forEach(function(a){c.available.activityTypes.push(a.name),c.metadata[a.name]=a.metadata}),this.setActivityType(this.available.activityTypes[0]),this.data.metadata.synergyTypes.forEach(function(a){c.metadata[a.name]=a.metadata,c.available.synergyTypes.push(a.name)}),this.setSynergyType(this.available.synergyTypes[0]),this.linkUp(),this},c.loadExample=function(d,e){var f=b.defer();return a.get("data/"+d+"/data.json").then(function(a){return c.datasetName=d,c.data=a.data,c.initializeData(),f.resolve(a)}).then(e),f.promise},c}]),angular.module("frontendApp").controller("MapCtrl",["$scope","$routeParams","dataService","settings","$window",function(a,b,c,d,e){a.datasetName=b.dataset,a.settings=d,a.svgStyle={position:"absolute",top:"45px",width:angular.element(e).width(),height:angular.element(e).height()-45},e.onresize=function(){a.svgStyle.width=angular.element(e).width(),a.svgStyle.height=angular.element(e).height()-45,a.$apply()},a.model=c.model,a.tooltip={visibility:!1},a.$watch("tooltip.visibility",function(b){b===!1&&(a.model.selected=null)}),a.select=function(b){a.model.selected=b},a.$watch("model.selected",function(b){if(console.log("selected:",b),null===b)a.tooltip.visibility=!1;else if(a.tooltip.visibility=!0,c.data.compounds.indexOf(b)>-1){var d=b;a.tooltip.data={compound:!0,object:d,neighbors:c.data.combinations.filter(function(a){return a.source===b||a.target===b})}}else if(c.data.combinations.indexOf(b)>-1){var e=b;a.tooltip.data={compound:!1,object:e}}}),a.slider={min:-1,leftValue:-.5,centerLimit:0,rightValue:.5,max:1},c.loadExample(b.dataset,function(){a.data=c.data;var b=d3.extent(a.data.combinations,function(a){return a.value});a.slider.min=+(1.05*b[0]).toPrecision(4),a.slider.max=+(1.05*b[1]).toPrecision(4),a.slider.leftValue=.3*a.slider.min,a.slider.rightValue=.3*a.slider.max,a.$watch("dataService.current.synergyType",function(){var b=d3.extent(a.data.combinations,function(a){return a.value});a.slider.min=+(1.05*b[0]).toPrecision(4),a.slider.max=+(1.05*b[1]).toPrecision(4)})})}]),angular.module("frontendApp").directive("tooltip",["dataService",function(a){return{scope:{visibility:"=",data:"=",height:"@",click:"="},templateUrl:"views/tooltip.html",restrict:"E",link:function(b,c){var d=$(c[0]);b.dataService=a,b.$watch("height",function(){d.css("max-height",b.height+"px")}),b.close=function(){b.visibility=!1},b.$watch("visibility",function(a){a?d.show(400):d.hide(400)})}}}]),angular.module("frontendApp").directive("synergySlider",function(){return{scope:{min:"=",max:"=",centerLimit:"=",leftValue:"=",rightValue:"=",leftColor:"=",leftName:"@",rightColor:"=",rightName:"@"},templateUrl:"views/synergy-slider.html",restrict:"E",link:function(a){extendSlider();var b=$('<div class="left section"></div>'),c=$('<span class="sm-label">left</span>'),d=$('<div class="right section"></div>'),e=$('<span class="sm-label">right</span>'),f=$("#slider"),g=d3.scale.linear().domain([a.min,a.max]).range([0,340]);f.append([b,d,$('<svg class="axis"></svg>')]),e.appendTo(d),c.appendTo(b),e.text(a.rightName),c.text(a.leftName),d.css({width:340-g(a.centerLimit)+"px",background:a.rightColor}),b.css({width:g(a.centerLimit)+"px",background:a.leftColor});var h=d3.select("svg.axis"),i=d3.svg.axis().scale(g).ticks(6).orient("bottom");h.attr("height",30).call(i),f.slider({range:!0,min:a.min,max:a.max,lowMax:a.centerLimit,topMin:a.centerLimit,step:.01,values:[a.leftValue,a.rightValue],animate:"fast",slide:function(b,c){a.leftValue=c.values[0],a.rightValue=c.values[1],a.$apply()}}),a.$watch("rightColor",function(){d.css("background","rgba("+a.rightColor.r+", "+a.rightColor.g+", "+a.rightColor.b+", 0.3)"),e.css("color","rgb("+a.rightColor.r+", "+a.rightColor.g+", "+a.rightColor.b+")")}),a.$watch("leftColor",function(){b.css("background","rgba("+a.leftColor.r+", "+a.leftColor.g+", "+a.leftColor.b+", 0.3)"),c.css("color","rgb("+a.leftColor.r+", "+a.leftColor.g+", "+a.leftColor.b+")")}),a.$watch("[min, centerLimit, max]",function(c){var e=c[0],i=c[1],j=c[2];a.leftValue=.5*(i+e),a.rightValue=.5*(i+j),g=d3.scale.linear().domain([e,j]).range([0,340]),d.css("width",340-g(a.centerLimit)+"px"),b.css("width",g(a.centerLimit)+"px");var k=d3.svg.axis().scale(g).ticks(6).orient("bottom");h.empty(),h.attr("height",30).call(k),f.slider({min:e,values:[a.leftValue,a.rightValue],centerLimit:i,max:j})})}}});